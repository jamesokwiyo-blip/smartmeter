name: Keep-Alive Ping

# This workflow pings the Render.com API every 5 minutes to prevent auto-suspension
# Free tier services on Render.com suspend after 15 minutes of inactivity

on:
  schedule:
    # Run every 5 minutes (cron format: minute hour day month weekday)
    - cron: '*/5 * * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  ping-api:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Health Endpoint
        run: |
          echo "Pinging API to keep service awake..."
          response=$(curl -s -w "\n%{http_code}" https://smartmeter-jdw0.onrender.com/api/health)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" -eq 200 ]; then
            echo "✅ API is online: $body"
            exit 0
          else
            echo "⚠️ API returned HTTP $http_code: $body"
            # Don't fail the workflow - service might be waking up
            exit 0
          fi
      
      - name: Ping Pending Token Endpoint (Optional)
        continue-on-error: true
        run: |
          # This endpoint doesn't require auth, so it's safe to ping
          curl -s -o /dev/null -w "Status: %{http_code}\n" \
            https://smartmeter-jdw0.onrender.com/api/purchases/pending-token/0215002079873 || true
